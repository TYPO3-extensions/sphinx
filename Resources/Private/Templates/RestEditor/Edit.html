{namespace sphinx=Causal\Sphinx\ViewHelpers}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>{document}</title>

	<link rel="stylesheet" type="text/css" href="{f:uri.resource(path:'Css/main.css')}" />
	<link rel="stylesheet" type="text/css" href="{f:uri.resource(path:'Css/jquery-ui.smoothness/jquery-ui-1.10.3.custom.min.css')}" />

	<sphinx:includeJs.jQuery version="1.10"/>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery-migrate-1.2.1.min.js')}"></script>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery-ui-1.10.3.custom.min.js')}"></script>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery.treetable-3.0.2.min.js')}"></script>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery.layout-latest.min.js')}"></script>
	<script type="text/javascript">
		var autocompleteAction = "{f:uri.action(action:'autocomplete')}";
		var referencesAction = "{f:uri.action(action:'accordionReferences',arguments:{reference:'REFERENCE', remoteUrl:'URL', usePrefix:'USE_PREFIX'})}";
		var currentReference = "EXT:{extensionKey}";
	</script>
	<script type="text/javascript"><![CDATA[
		var myLayout; // a var is required because this page utilizes: myLayout.allowOverflow() method
		var isDirty = false;
		var editor;

		$(document).ready(function() {
			$("#extension-key")
				.bind('loadReferences', function(event, reference, url) {
					$.ajax({
						url: referencesAction
								.replace(/REFERENCE/, reference)
								.replace(/URL/, url)
								.replace(/USE_PREFIX/, reference != currentReference ? '1' : '0')
					}).done(function(data) {
						$('#accordion-objectsinv')
							.accordion('destroy')
							.html(data['html'])
							.accordion({ heightStyle: 'fill' });	// Problem if too many chapters (e.g., TYPO3 API)
						$('#tx-sphinx-accordion-header').html(reference);
					});
				})
				.autocomplete({
					source: autocompleteAction,
					minLength: 2,
					position: { my : "right top", at: "right bottom" },
					select: function(event, ui) {
						if (ui.item) {
							$(this).trigger('loadReferences', [ui.item.value, ui.item.id]);
						}
					},
					change: function(event, ui) {
						if ($(this).val().length == 0) {
							// Reset the references to current document
							$(this).trigger('loadReferences', currentReference);
						}
					}
				});

			// Initializes tooltips
			$(document).tooltip();

			myLayout = $('body').layout({
					west__size:					250
				,	west__minSize:				200
				,	west__maxSize:				.3 // 30% of layout width
				,	east__size:					300
				,	east__minSize:				300
				,	east__maxSize:				.4 // 40% of layout width
				,	east__initClosed:			false
				,	east__initHidden:			false
				,	east__slidable:				true
				,	east__resizable:			true
				,	south__resizable:			false

				//	Enable state management
				,	stateManagement__enabled:	true // automatic cookie load & save enabled by default
			});

			editor = ace.edit("editor");
			var session = editor.getSession()

			editor.setTheme("ace/theme/github");
			session.setMode("ace/mode/markdown");

			editor.on("change", function(e) {
				isDirty = true;
			});

			editor.setPrintMarginColumn(120);
			session.setUseWrapMode(true);
			session.setWrapLimitRange(120, 120);
		});
	]]></script>
</head>
<body>

<f:render partial="Documentation/HeaderToolbar" arguments="{buttons: buttons}" />

<pre id="editor" class="ui-layout-center">{contents}</pre>

<div class="ui-layout-east layout-content-container">
	<div class="ui-widget-header no-scrollbar add-padding">
		<f:translate key="editor.header.references"/>
		<span id="tx-sphinx-accordion-header">EXT:{extensionKey}</span>
	</div>
	<div class="ui-widget">
		<label for="extension-key" title="{f:translate(key:'editor.tooltip.input')}"><f:translate key="editor.label.loadReference"/></label>
		<input id="extension-key" style="width:180px" />
	</div>
	<sphinx:objectsInvBrowser id="accordion-objectsinv" reference="{reference}" aceEditor="editor" controller="{controller}" />
</div>

<div class="ui-layout-west layout-content-container layout-scroll">
	<sphinx:projectTree projectPath="{projectPath}" reveal="{filename}" />
</div>

<div class="ui-layout-south">
	<f:translate key="editor.label.filename"/> <span id="filename">{filename}</span>
</div>

<script src="{f:uri.resource(path:'JavaScript/Ace/ace.js')}" type="text/javascript" charset="utf-8"></script>
<script>
var reference = "{reference}";
var filename = "{file}";
var redirectUrl = "{f:uri.action(action:'render', controller:'InteractiveViewer', arguments:{reference:reference, document:document})}";

function openFile(file) {
	if (isDirty) {
		var r = confirm('Your current document has been modified. Are you sure you want to open document “' + file + '”?');
		if (!r) {
			return;
		}
	}

	var openUrl = "{f:uri.action(action:'open')}";

	$.post(openUrl,
		{
			'tx_sphinx_help_sphinxdocumentation[reference]': reference,
			'tx_sphinx_help_sphinxdocumentation[filename]': file,
		},
		function(data) {
			if (data.status == 'success') {
				editor.setValue(data.contents);
				editor.gotoLine(1);
				filename = file;
				$("#filename").html(file);
				isDirty = false;
			} else {
				alert(data.statusText);
			}
		}
	);
}

function closeEditor() {
	if (isDirty) {
		var r = confirm('Do you want to save the changes you made in the document “' + filename + '”?');
		if (r) {
			saveAndClose();
			return;
		}
	}
	document.location.href = redirectUrl;
}

function save() {
	var contents = editor.getSession().getValue();
	var saveUrl = "{f:uri.action(action:'save')}";

	$.post(saveUrl,
		{
			'tx_sphinx_help_sphinxdocumentation[reference]': reference,
			'tx_sphinx_help_sphinxdocumentation[filename]': filename,
			'tx_sphinx_help_sphinxdocumentation[contents]': contents,
			'tx_sphinx_help_sphinxdocumentation[compile]': 0
		},
		function(data) {
			if (data.status == 'success') {
				isDirty = false;
				alert('successful save');
			} else {
				alert(data.statusText);
			}
		}
	);
}

function saveAndClose() {
	var contents = editor.getSession().getValue();
	var saveUrl = "{f:uri.action(action:'save')}";

	$.post(saveUrl,
		{
			'tx_sphinx_help_sphinxdocumentation[reference]': reference,
			'tx_sphinx_help_sphinxdocumentation[filename]': filename,
			'tx_sphinx_help_sphinxdocumentation[contents]': contents,
			'tx_sphinx_help_sphinxdocumentation[compile]': 1
		},
		function(data) {
			if (data.status == 'success') {
				document.location.href = redirectUrl;
			} else {
				alert(data.statusText);
			}
		}
	);
}
</script>

</body>
</html>