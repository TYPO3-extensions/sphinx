{namespace sphinx=Causal\Sphinx\ViewHelpers}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>{document}</title>

	<link rel="stylesheet" type="text/css" href="{f:uri.resource(path:'Css/main.css')}" />
	<link rel="stylesheet" type="text/css" href="{f:uri.resource(path:'Css/jquery-ui.smoothness/jquery-ui-1.10.3.custom.min.css')}" />

	<sphinx:includeJs.jQuery version="1.10"/>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery-migrate-1.2.1.min.js')}"></script>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery.layout-latest.min.js')}"></script>
	<script type="text/javascript" src="{f:uri.resource(path:'JavaScript/jquery-ui-1.10.3.custom.min.js')}"></script>
	<script type="text/javascript"><![CDATA[
		var myLayout; // a var is required because this page utilizes: myLayout.allowOverflow() method

		$(document).ready(function() {
			myLayout = $('body').layout({
					east__size:					300
				,	east__minSize:				200
				,	east__maxSize:				.5 // 50% of layout width
				,	east__initClosed:			false
				,	east__initHidden:			false
				,	east__slidable:				true
				,	east__resizable:			true

				//	Enable state management
				,	stateManagement__enabled:	true // automatic cookie load & save enabled by default
			});
		});
	]]></script>
</head>
<body>

<f:render partial="Documentation/HeaderToolbar" arguments="{buttons: buttons}" />

<div id="editor" class="ui-layout-center">{contents}</div>

<div class="ui-layout-east layout-content-container">
	<sphinx:objectsInvBrowser reference="{reference}" aceEditor="editor" />
</div>

<script src="{f:uri.resource(path:'JavaScript/Ace/ace.js')}" type="text/javascript" charset="utf-8"></script>
<script>
var editor = ace.edit("editor");
var session = editor.getSession()

editor.setTheme("ace/theme/github");
session.setMode("ace/mode/markdown");

editor.setPrintMarginColumn(120);
session.setUseWrapMode(true);
session.setWrapLimitRange(120, 120);

var reference = "{reference}";
var doc = "{document}";
var redirectUrl = "{f:uri.action(action:'render', controller:'InteractiveViewer', arguments:{reference:reference, document:document})}";

function closeEditor() {
	// TODO: check if file was modified
	document.location.href = redirectUrl;
}

function save() {
	var contents = editor.getSession().getValue();
	var saveUrl = "{f:uri.action(action:'save')}";

	$.post(saveUrl,
			{
				'tx_sphinx_help_sphinxdocumentation[reference]': reference,
				'tx_sphinx_help_sphinxdocumentation[document]': doc,
				'tx_sphinx_help_sphinxdocumentation[contents]': contents,
				'tx_sphinx_help_sphinxdocumentation[compile]': 0
			},
			function(data) {
				if (data.status == 'success') {
					alert('successful save');
				} else {
					alert(data.statusText);
				}
			}
	);
}

function saveAndClose() {
	var contents = editor.getSession().getValue();
	var saveUrl = "{f:uri.action(action:'save')}";

	$.post(saveUrl,
			{
				'tx_sphinx_help_sphinxdocumentation[reference]': reference,
				'tx_sphinx_help_sphinxdocumentation[document]': doc,
				'tx_sphinx_help_sphinxdocumentation[contents]': contents,
				'tx_sphinx_help_sphinxdocumentation[compile]': 1
			},
			function(data) {
				if (data.status == 'success') {
					document.location.href = redirectUrl;
				} else {
					alert(data.statusText);
				}
			}
	);
}
</script>

</body>
</html>